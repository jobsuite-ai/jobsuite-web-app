version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
        # Write AWS_BRANCH to .env file for runtime access in Next.js API routes
        - echo "AMPLIFY_BRANCH=$AWS_BRANCH" >> .env.production
        # Set NODE_ENV based on branch (optional - for Next.js .env file loading)
        - |
          if [ "$AWS_BRANCH" = "prod" ] || [ "$AWS_BRANCH" = "production" ]; then
            export NODE_ENV=production
            echo "Building for PRODUCTION ($AWS_BRANCH branch)"
          elif [ "$AWS_BRANCH" = "qa" ] || [ "$AWS_BRANCH" = "staging" ]; then
            export NODE_ENV=development
            echo "Building for QA/STAGING ($AWS_BRANCH branch)"
          else
            export NODE_ENV=development
            echo "Building for DEVELOPMENT ($AWS_BRANCH branch)"
          fi
        # Debug: Show which environment variables are available
        - "echo \"Branch: $AWS_BRANCH\""
        - "echo \"NODE_ENV: $NODE_ENV\""
        - "echo \"AMPLIFY_BRANCH written to .env.production: $AWS_BRANCH\""
        - "echo \"WEBHOOK_EMAIL configured: $([ -n \"$WEBHOOK_EMAIL\" ] && echo 'yes' || echo 'no')\""
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .next/cache/**/*
      - .npm/**/*
      - node_modules/**/*